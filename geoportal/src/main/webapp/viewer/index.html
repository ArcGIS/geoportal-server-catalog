<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <title>MapImageLayer - create dynamic map layers | Sample | ArcGIS Maps SDK for JavaScript 4.31</title>

        <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
        <script src="https://js.arcgis.com/4.31/"></script>

        <style>
            html,
            body,
            #viewDiv {
                padding: 0;
                margin: 0;
                height: 100%;
                width: 100%;
            }

            #info-div {
                background-color: white;
                border-radius: 8px;
                padding: 8px;
                opacity: 0.92;
            }
        </style>

        <script>
            require([
                    "esri/Map", 
                    "esri/core/reactiveUtils",
                    "esri/views/SceneView",
                    "esri/views/MapView", 
                    "esri/widgets/Search",
                    "esri/widgets/BasemapGallery",
                    "esri/layers/GroupLayer",
                    "esri/layers/CSVLayer",
                    "esri/layers/FeatureLayer", 
                    "esri/layers/ImageryTileLayer",
                    "esri/layers/MapImageLayer", 
                    "esri/widgets/Legend",
                    "esri/widgets/Expand", 
                    "esri/widgets/LayerList",
                    "esri/widgets/Slider"
                ], (
                    Map,
                    reactiveUtils,
                    SceneView,
                    MapView,
                    Search,
                    BasemapGallery,
                    GroupLayer,
                    CSVLayer,
                    FeatureLayer,
                    ImageryTileLayer,
                    MapImageLayer,
                    Legend,
                    Expand,
                    LayerList,
                    Slider) => {

                window.map = new Map({
                    basemap: "gray-vector"
                            //, layers: [layer]
                });

                const view = new MapView({
                    container: "viewDiv",
                    map: window.map,
                    zoom: 1,
                    center: [0, 30]
                });
                
                window.addLayer = function(thisMap, title, type, url) {
                    console.warn("type, url = " + type + " -> " + url);
                    if (type === "MapServer") {
                        const layer = new MapImageLayer({
                            url: url,
                            title: title,
                        });
                        thisMap.add(layer);
                    } else if (type === "FeatureServer") {
                        const layer = new FeatureLayer({
                            url: url,
                            title: title,
                        });
                        thisMap.add(layer);
                    } else if (type === "ImageryTileLayer") {
                        const layer = new ImageryTileLayer({
                            url: url,
                            title: title,
                        });
                        thisMap.add(layer);
                    } else if (type === "CSV") {
                        const layer = new CSVLayer({
                            url: url,
                            title: title,
                        });
                        thisMap.add(layer);
                    }
                };

                if (!window.addToMapListener) {
                    window.addToMapListener = function (params) {
                        console.warn("addToMapListener", params);
                        return window.addLayer(window.map, params.title, params.type, params.url);
                    };
                };

                this._checkWindowUrl();
                

                // Creates actions in the LayerList.
                async function defineActions(event) {
                    // The event object contains an item property.
                    // is is a ListItem referencing the associated layer
                    // and other properties. You can control the visibility of the
                    // item, its title, and actions using this object.
                    const { item } = event;

                    await item.layer.when();

                    if (1 === 1) {  //(item.title === "US Demographics") {
                        // An array of objects defining actions to place in the LayerList.
                        // By making this array two-dimensional, you can separate similar
                        // actions into separate groups with a breaking line.
                        item.actionsSections = [
                            [
                                {
                                    title: "Go to full extent",
                                    icon: "zoom-out-fixed",
                                    id: "full-extent"
                                },
                                {
                                    title: "Layer information",
                                    icon: "information",
                                    id: "information"
                                }
                            ],
                            [
                                {
                                    title: "Increase opacity",
                                    icon: "chevron-up",
                                    id: "increase-opacity"
                                },
                                {
                                    title: "Decrease opacity",
                                    icon: "chevron-down",
                                    id: "decrease-opacity"
                                }
                            ]
                        ];
                    }

                    // Adds a slider for updating a group layer's opacity
                    if (item.children.length > 1 && item.parent) {
                        const slider = new Slider({
                            min: 0,
                            max: 1,
                            precision: 2,
                            values: [1],
                            visibleElements: {
                              labels: true,
                              rangeLabels: true
                            }
                        });

                        item.panel = {
                            content: slider,
                            icon: "sliders-horizontal",
                            title: "Change layer opacity"
                        };

                        // Watch the slider's values array and update the layer's opacity
                        reactiveUtils.watch(
                            () => slider.values.map((value) => value),
                            (values) => (item.layer.opacity = values[0])
                        );
                    }
                }


                // ADD WIDGETS
                view.when(() => {
                    // Add the search widget to the top right corner of the view
                    const searchWidget = new Expand({
                        content: new Search({
                            view: view,
                            style: "card"
                        }),
                        view: view,
                        group: "top-right",
                        expanded: false
                    });

                    view.ui.add(searchWidget, {
                      position: "top-right"
                    });
                    
                    // add a legend widget instance to the view
                    // and set the style to 'card'. This is a
                    // responsive style, which is good for mobile devices
                    const legend = new Expand({
                      content: new Legend({
                        view: view,
                        style: "card"
                      }),
                      view: view,
                      group: "top-right",
                      expanded: false
                    });
                    view.ui.add(legend, "top-right");
                    
                    // Create the LayerList widget with the associated actions
                    // and add it to the top-right corner of the view.
                    const layerList = new Expand({
                      content: new LayerList({
                        view: view,
                        container: document.getElementById("layerListDiv"),
                        // executes for each ListItem in the LayerList
                        listItemCreatedFunction: defineActions
                      }),
                      view: view,
                      group: "top-right",
                      expanded: false
                    });

                    // Event listener that fires each time an action is triggered
                    layerList.on("trigger-action", (event) => {
                        // The layer visible in the view at the time of the trigger.
                        const visibleLayer = USALayer.visible ? USALayer : censusLayer;

                        // Capture the action id.
                        const id = event.action.id;

                        if (id === "full-extent") {
                            // If the full-extent action is triggered then navigate
                            // to the full extent of the visible layer
                            view.goTo(visibleLayer.fullExtent).catch((error) => {
                                if (error.name !== "AbortError") {
                                  console.error(error);
                                }
                            });
                        } else if (id === "information") {
                            // If the information action is triggered, then
                            // open the item details page of the service layer
                            window.open(visibleLayer.url);
                        } else if (id === "increase-opacity") {
                            // If the increase-opacity action is triggered, then
                            // increase the opacity of the GroupLayer by 0.25
                            if (demographicGroupLayer.opacity < 1) {
                                demographicGroupLayer.opacity += 0.25;
                            }
                        } else if (id === "decrease-opacity") {
                            // If the decrease-opacity action is triggered, then
                            // decrease the opacity of the GroupLayer by 0.25
                            if (demographicGroupLayer.opacity > 0) {
                                demographicGroupLayer.opacity -= 0.25;
                            }
                        }
                    });

                    // Add widget to the top right corner of the view
                    view.ui.add(layerList, "top-right");

                    // Add basemap gallery
                    const basemapGallery = new Expand({
                      content: new BasemapGallery({
                        view: view,
                        style: "card"
                      }),
                      view: view,
                      group: "top-right",
                      expanded: false
                    });                   
                    view.ui.add(basemapGallery, {
                      position: "top-right"
                    });
                    
                });
            });

            function _checkWindowUrl() {
                //console.warn("AddToMap._checkWindowUrl...");
                var queryObject = this._parseParameters(); // window.queryObject; env.js // <-- did not work well, so using above function
                if (queryObject.resource) {
                    var resource = queryObject.resource;
                    //console.warn("Add to map parameters => " + resource);        
                    var title = "";
                    if (queryObject.title) {
                        title = decodeURIComponent(queryObject.title);
                    }
                    var parts = resource.split(":");
                    if (!parts && parts.length < 2) {
                        return;
                    }

                    var linkType = parts[0];
                    var href = "";
                    // loop parameter values in array elements since value may contain ':'
                    for (var i = 1; i < parts.length; i++) {
                        if (href.length > 0) {
                            href += ":";
                        }
                        href += parts[i];
                    }
                    if (href.length === 0)
                        return;
                    window.addLayer(map, title, linkType, href);
                }
            };
            
            function _parseParameters() {
                var query = window.location.search;
                if (query.indexOf('?') > -1) {
                    query = query.substr(1);
                }
                var pairs = query.split('&');
                var queryObject = {};
                for (var i = 0; i < pairs.length; i++) {
                    var splits = decodeURIComponent(pairs[i]).split('=');
                    var parameterValue = "";
                    // loop parameter values in array elements since value may contain '='
                    for (var j = 1; j < splits.length; j++) {
                        if (parameterValue.length > 0) {
                            parameterValue += "=";
                        }
                        parameterValue += splits[j];
                    }
                    queryObject[splits[0]] = parameterValue;
                }
                return queryObject;
            };
            
            
        </script>
    </head>

    <body>
        <div id="viewDiv">
        </div>
    </body>
</html>