<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <title>MapImageLayer - create dynamic map layers | Sample | ArcGIS Maps SDK for JavaScript 4.31</title>

        <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
        <script src="https://js.arcgis.com/4.31/"></script>

        <style>
            html,
            body,
            #viewDiv {
                padding: 0;
                margin: 0;
                height: 100%;
                width: 100%;
            }

            #info-div {
                background-color: white;
                border-radius: 8px;
                padding: 8px;
                opacity: 0.92;
            }
        </style>

        <script>
            var dojoConfig = this.dojoConfig || {};
            
            require([
                    "esri/Map", 
                    "esri/core/reactiveUtils",
                    "esri/views/SceneView",
                    "esri/views/MapView", 
                    "esri/widgets/Search",
                    "esri/widgets/BasemapGallery",
                    "esri/layers/GroupLayer",
                    "esri/layers/CSVLayer",
                    "esri/layers/FeatureLayer", 
                    "esri/layers/ImageryTileLayer",
                    "esri/layers/MapImageLayer", 
                    "esri/widgets/Legend",
                    "esri/widgets/Expand", 
                    "esri/widgets/LayerList",
                    "esri/widgets/Slider"
                ], (
                    Map,
                    reactiveUtils,
                    SceneView,
                    MapView,
                    Search,
                    BasemapGallery,
                    GroupLayer,
                    CSVLayer,
                    FeatureLayer,
                    ImageryTileLayer,
                    MapImageLayer,
                    Legend,
                    Expand,
                    LayerList,
                    Slider) => {

                window.map = new Map({
                    basemap: "gray-vector"
                            //, layers: [layer]
                });

                const view = new MapView({
                    container: "viewDiv",
                    map: window.map,
                    zoom: 1,
                    center: [0, 30]
                });
                
                window.addLayer = function(thisMap, title, type, url) {
                    console.warn("type, url = " + type + " -> " + url);
                    var layer;
                    if (type === "MapServer") {
                        layer = new MapImageLayer({
                            url: url,
                            title: title
                        });
                        thisMap.add(layer);
                    } else if (type === "FeatureServer") {
                        layer = new FeatureLayer({
                            url: url,
                            title: title
                        });
                        thisMap.add(layer);
                    } else if (type === "ImageryTileLayer") {
                        layer = new ImageryTileLayer({
                            url: url,
                            title: title
                        });
                        thisMap.add(layer);
                    } else if (type === "CSV") {
                        layer = new CSVLayer({
                            url: url,
                            title: title
                        });
                        thisMap.add(layer);
                    }
                    
                    view.when(() => {
                        if ((layer) && (layer.Extent)) {
                            view.goTo(layer.fullExtent).catch((error) => {
                                if (error.name !== "AbortError") {
                                  console.error(error);
                                }
                            });
                        }
                    });
                };

                if (!window.addToMapListener) {
                    window.addToMapListener = function (params) {
                        console.warn("addToMapListener", params);
                        return window.addLayer(window.map, params.title, params.type, params.url);
                    };
                };

                this._checkWindowUrl();
                
                
                // ADD WIDGETS
                view.when(() => {
                    // Add the search widget to the top right corner of the view
                    const searchWidget = new Expand({
                        content: new Search({
                            view: view,
                            style: "card"
                        }),
                        view: view,
                        group: "top-right",
                        expanded: false
                    });

                    view.ui.add(searchWidget, {
                      position: "top-right"
                    });
                    
                    // add a legend widget instance to the view
                    // and set the style to 'card'. This is a
                    // responsive style, which is good for mobile devices
                    const legend = new Expand({
                      content: new Legend({
                        view: view,
                        style: "card"
                      }),
                      view: view,
                      group: "top-right",
                      expanded: false
                    });
                    view.ui.add(legend, "top-right");
                    
                    // Create the LayerList widget with the associated actions
                    // and add it to the top-right corner of the view.
                    const layerList = new Expand({
                      content: new LayerList({
                        view: view,
                        container: document.getElementById("layerListDiv")
                      }),
                      view: view,
                      group: "top-right",
                      expanded: false
                    });

                    // Add widget to the top right corner of the view
                    view.ui.add(layerList, "top-right");

                    // Add basemap gallery
                    const basemapGallery = new Expand({
                      content: new BasemapGallery({
                        view: view,
                        style: "card"
                      }),
                      view: view,
                      group: "top-right",
                      expanded: false
                    });                   
                    view.ui.add(basemapGallery, {
                      position: "top-right"
                    });
                });
            });

            function _checkWindowUrl() {
                //console.warn("AddToMap._checkWindowUrl...");
                var queryObject = this._parseParameters(); // window.queryObject; env.js // <-- did not work well, so using above function
                if (queryObject.resource) {
                    var resource = queryObject.resource;
                    //console.warn("Add to map parameters => " + resource);        
                    var title = "";
                    if (queryObject.title) {
                        title = decodeURIComponent(queryObject.title);
                    }
                    var parts = resource.split(":");
                    if (!parts && parts.length < 2) {
                        return;
                    }

                    var linkType = parts[0];
                    var href = "";
                    // loop parameter values in array elements since value may contain ':'
                    for (var i = 1; i < parts.length; i++) {
                        if (href.length > 0) {
                            href += ":";
                        }
                        href += parts[i];
                    }
                    if (href.length === 0)
                        return;
                    window.addLayer(map, title, linkType, href);
                }
            };
            
            function _parseParameters() {
                var query = window.location.search;
                if (query.indexOf('?') > -1) {
                    query = query.substr(1);
                }
                var pairs = query.split('&');
                var queryObject = {};
                for (var i = 0; i < pairs.length; i++) {
                    var splits = decodeURIComponent(pairs[i]).split('=');
                    var parameterValue = "";
                    // loop parameter values in array elements since value may contain '='
                    for (var j = 1; j < splits.length; j++) {
                        if (parameterValue.length > 0) {
                            parameterValue += "=";
                        }
                        parameterValue += splits[j];
                    }
                    queryObject[splits[0]] = parameterValue;
                }
                return queryObject;
            };
        </script>
    </head>

    <body>
        <div id="viewDiv"></div>
    </body>
</html>